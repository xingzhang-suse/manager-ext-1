<template>
    <div>
      <ag-grid-vue
        id="agGrid"
        style="width: 100%; height: 335px"
        :class="isLightTheme ? 'ag-theme-balham' : 'ag-theme-balham-dark'"
        :columnDefs="columnDefs"
        :gridOptions="gridOptions"
      >
      </ag-grid-vue>
      <VulnerabilityInfoModal v-if="showInfoModal" :vulnerability="selectedInfo" :isLightTheme="isLightTheme" @close="closeInfo"></VulnerabilityInfoModal>
    </div>
</template>
    
<script>
    import { Banner } from '@rancher/components';
    import 'ag-grid-community/styles/ag-grid.css';
    import 'ag-grid-community/styles/ag-theme-balham.min.css';
    import { AgGridVue } from 'ag-grid-vue';
    import { arrayToCsv } from '../../../utils/common';
    import { getCsvData } from '../../../utils/vulnerabilities';
    import { getVulnerabilitiesQuery, postCVEProfile } from '../../../plugins/vulnerabilities-class';
    import VulnerabilityScoreCellComponent from './components/VulnerabilityScoreCellComponent.vue';
    import VulnerabilityImpactCellComponent from './components/VulnerabilityImpactCellComponent.vue';
    import VulnerabilityActionCellComponent from './components/VulnerabilityActionCellComponent.vue';
    import VulnerabilityInfoModal from '../dialogs/VulnerabilityInfoModal.vue';
    import { saveAs } from 'file-saver';
    import dayjs from 'dayjs';
    import { nvVariables } from '../../../types';

    export default {
        props: {
            totalRecords: Number,
            activeToken: String,
            selectedScore: String,
            filterText: String,
            isLightTheme: Boolean,
        },
        data() {
            return {
                showInfoModal: false,
                selectedInfo: null,
                columnDefs: null,
                gridOptions: null,
                gridApi: null,
                cacheBlockSize: 300,
                paginationPageSize: 100,
                datasource: {
                    getRows: params => {
                        let queryParams = {
                            token: this.activeToken,
                            start: params.startRow,
                            row: this.cacheBlockSize,
                        };
                        if (params.sortModel.length) {
                            queryParams = {
                                ...queryParams,
                                orderbyColumn: params.sortModel[0].colId,
                                orderby: params.sortModel[0].sort,
                            };
                        }
                        if ('-' in params.filterModel) {
                            queryParams = {
                                ...queryParams,
                                qf: params.filterModel['-'].filter,
                                scoretype: this.selectedScore.toLowerCase(),
                            };
                        }
                        getVulnerabilitiesQuery(queryParams)
                            .then(response => {
                                if ('qf' in queryParams) {
                                    this.$emit('qfMatched', response.data.qf_matched_records);
                                    params.successCallback(response.data.vulnerabilities, this.totalRecords);
                                } else {
                                    params.successCallback(response.data.vulnerabilities, this.totalRecords);
                                }
                            })
                            .catch(err => {
                                console.log(err);
                            })
                    },
                }
            };
        },
        components: {
            Banner,
            AgGridVue,
            VulnerabilityScoreCellComponent,
            VulnerabilityImpactCellComponent,
            VulnerabilityActionCellComponent,
            VulnerabilityInfoModal
        },
        beforeMount() {
            this.columnDefs = [
                {
                    field: '-',
                    hide: true,
                    lockVisible: true,
                    filter: 'agTextColumnFilter',
                    filterParams: {
                        newRowsAction: 'keep',
                    },
                },
                {
                    headerName: this.t('scan.gridHeader.NAME'),
                    field: 'name',
                    sortable: true,
                    resizable: true,
                    width: 130,
                    minWidth: 130
                },
                {
                    field: 'severity',
                    hide: true,
                },
                {
                    headerName: this.t('scan.gridHeader.SCORE_V2'),
                    field: 'score',
                    hide: true,
                    sortable: true,
                    resizable: true,
                    cellRenderer: 'VulnerabilityScoreCellComponent',
                    cellRendererParams: {
                        type: 'V2',
                    },
                    width: 140,
                    maxWidth: 140,
                    minWidth: 140,
                },
                {

                    headerName: this.t('scan.gridHeader.SCORE_V3'),
                    field: 'score_v3',
                    sortable: true,
                    resizable: true,
                    cellRenderer: 'VulnerabilityScoreCellComponent',
                    cellRendererParams: {
                        type: 'V3',
                    },
                    width: 140,
                    maxWidth: 140,
                    minWidth: 140,
                },
                {
                    headerName: this.t('scan.gridHeader.PUBLISHED_TIME'),
                    field: 'published_timestamp',
                    sortable: true,
                    resizable: true,
                    valueFormatter: params => {
                        if (!params.data) return '';
                        const date = new Date(params.data.published_timestamp * 1000);
                        const dateString = date.toDateString().split(' ').slice(1);
                        dateString[1] = dateString[1] + ',';
                        return dateString.join(' ');
                    },
                    width: 130,
                    maxWidth: 150,
                    minWidth: 130,
                },
                {
                    headerName: this.t('scan.gridHeader.VICTIM'),
                    colId: 'impact',
                    sortable: true,
                    resizable: true,
                    cellRenderer: 'VulnerabilityImpactCellComponent',
                },
                {
                    headerName: this.t('setting.ACTIONS'),
                    resizable: true,
                    cellRenderer: 'VulnerabilityActionCellComponent',
                    cellRendererParams: {
                        showInfo: event => this.showInfo(event),
                        downloadCsv: event => this.downloadCsv(event),
                        acceptVul: event => this.acceptVul(event)
                    },
                    cellClass: ['flex-cell'],
                    width: 150,
                    maxWidth: 160,
                    minWidth: 150,
                }
            ];

            this.gridOptions = {
                headerHeight: 30,
                rowHeight: 30,
                suppressDragLeaveHidesColumns: true,
                animateRows: true,
                rowSelection: 'single',
                pagination: true,
                rowModelType: 'infinite',
                cacheBlockSize: this.cacheBlockSize,
                paginationPageSize: this.paginationPageSize,
                paginationPageSizeSelector: false,
                icons: {
                    sortAscending: '<em class="fa fa-sort-alpha-down"></em>',
                    sortDescending: '<em class="fa fa-sort-alpha-up"></em>',
                },
                onGridReady: params => {
                    this.gridApi = params.api;
                    this.gridApi.setGridOption('datasource', this.datasource);
                    setTimeout(() => {
                        this.gridApi.sizeColumnsToFit();
                    }, 300);
                    window.addEventListener('resize.#agGrid', () => {
                        setTimeout(() => {
                            this.gridApi.sizeColumnsToFit();
                        }, 100);
                    });
                },
                onModelUpdated: params => {
                    const firstRowNode = this.gridApi.getDisplayedRowAtIndex(0);
                    if (firstRowNode) {
                        firstRowNode.setSelected(true);
                    }
                },
                onSelectionChanged: params => {
                    this.$emit('togglePieChart', false);
                    if (params.api.getSelectedNodes()[0]) {
                        this.$emit('selectedVul', params.api.getSelectedNodes()[0].data);
                    }
                },
                overlayNoRowsTemplate: `<span class="overlay">No rows to show</span>`,
            };
        },
        methods: {
            showInfo(event) {
                this.selectedInfo = event.node.data;
                this.showInfoModal = true;
            },
            closeInfo(event) {
                this.showInfoModal = false;

            },
            downloadCsv(event) {
                let csv = arrayToCsv(getCsvData(event.node.data));
                let blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
                saveAs(blob, `Vulnerabilities_View_${dayjs(new Date()).format('YYYYMMDDHHmmss')}.csv`);
            },
            acceptVul(event) {
                const payload = {
                    entries: [
                        {
                            name: event.node.data.name,
                            days: 0,
                            comment: `Accepted by ${
                                nvVariables.user.username
                            } at ${dayjs(new Date()).format(
                                'MMM DD, YYYY HH:mm:ss'
                            )} from Vulnerabilities page`,
                            images: [],
                            domains: [],
                        },
                    ],
                    name: 'default',
                };
                postCVEProfile({config: payload})
                    .then(res => {
                        this.$emit('refresh');
                        this.$store.dispatch('growl/success', {
                            title:   'Success',
                            message: this.t('cveProfile.msg.ADD_OK'),
                            timeout: 5000,
                        }, { root: true });
                    }).catch(err => {
                        this.$store.dispatch('growl/error', {
                            title:   'Error',
                            message: this.t('cveProfile.msg.ADD_NG'),
                            timeout: 5000,
                        }, { root: true });
                    });
            },
            changeScoreView(selectedScore) {
                if (selectedScore === 'v2') {
                    this.gridApi.setColumnVisible('score_v3', false);
                    this.gridApi.setColumnVisible('score', true);
                } else {
                    this.gridApi.setColumnVisible('score', false);
                    this.gridApi.setColumnVisible('score_v3', true);
                }
                this.gridApi.sizeColumnsToFit();
            }
        },
        watch:  {
            activeToken(newToken, oldToken) {
                console.log('new', newToken, 'old', oldToken);
                this.gridApi.setGridOption('datasource', this.datasource);
            },
            filterText(newFilter, oldFilter) {
                console.log('new', newFilter, 'old', oldFilter);
                this.gridApi.setFilterModel({ '-': { filter: newFilter } });
            },
            selectedScore(newScore, oldScore) {
                console.log('new', newScore, 'old', oldScore);
                this.changeScoreView(newScore);
            }
        }
    };
</script>

<style scoped>
.flex-cell {
    display: flex;
    align-items: center;
}
</style>